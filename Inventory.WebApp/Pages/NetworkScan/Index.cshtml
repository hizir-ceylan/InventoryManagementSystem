@page
@model Inventory.WebApp.Pages.NetworkScan.IndexModel
@{
    ViewData["Title"] = "Ağ Tarama";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-search"></i> Ağ Tarama</h2>
                <a asp-page="/Devices/Index" class="btn btn-secondary">
                    <i class="fas fa-desktop"></i> Cihazlara Dön
                </a>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> @Model.StatusMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <!-- Network Scan Controls -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-radar"></i> Ağ Tarama Başlat</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        <div class="mb-3">
                            <label class="form-label">Ağ Aralığı (CIDR)</label>
                            <select class="form-select" asp-for="ScanRequest.NetworkRange" onchange="updateNetworkRange(this.value)">
                                <option value="">Tüm yerel ağları tara</option>
                                @foreach (var range in Model.LocalNetworkRanges)
                                {
                                    <option value="@range">@range</option>
                                }
                                <option value="custom">Özel aralık gir...</option>
                            </select>
                            <div class="form-text">
                                Boş bırakırsanız tüm yerel ağlar taranır
                            </div>
                        </div>

                        <div id="customRangeInput" style="display: none;" class="mb-3">
                            <label class="form-label">Özel Ağ Aralığı</label>
                            <input type="text" class="form-control" id="customRange" placeholder="örn: 192.168.1.0/24">
                            <div class="form-text">
                                CIDR formatında ağ aralığı girin (örn: 192.168.1.0/24)
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" asp-page-handler="StartScan" class="btn btn-primary">
                                <i class="fas fa-search"></i> Genel Ağ Taraması Başlat
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Port Scan Controls -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-ethernet"></i> Port Tarama</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        <input type="hidden" asp-for="ScanRequest.NetworkRange" id="portScanNetworkRange">
                        
                        <div class="mb-3">
                            <label class="form-label">Ağ Aralığı</label>
                            <select class="form-select" onchange="updatePortScanRange(this.value)">
                                <option value="">Tüm yerel ağlar</option>
                                @foreach (var range in Model.LocalNetworkRanges)
                                {
                                    <option value="@range">@range</option>
                                }
                                <option value="custom">Özel aralık...</option>
                            </select>
                        </div>

                        <div id="portCustomRangeInput" style="display: none;" class="mb-3">
                            <input type="text" class="form-control" id="portCustomRange" placeholder="örn: 192.168.1.0/24">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Hedef Port</label>
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="number" class="form-control" asp-for="ScanRequest.TargetPort" 
                                           placeholder="Port numarası" min="1" max="65535" required>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" onchange="setCommonPort(this.value)">
                                        <option value="">Yaygın portlar</option>
                                        <option value="22">22 (SSH)</option>
                                        <option value="23">23 (Telnet)</option>
                                        <option value="80">80 (HTTP)</option>
                                        <option value="443">443 (HTTPS)</option>
                                        <option value="3389">3389 (RDP)</option>
                                        <option value="5900">5900 (VNC)</option>
                                        <option value="161">161 (SNMP)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-text">
                                Belirli bir port için cihazları tarar
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" asp-page-handler="StartPortScan" class="btn btn-info">
                                <i class="fas fa-ethernet"></i> Port Taraması Başlat
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scan Status -->
    @if (Model.ScanStatus != null)
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Tarama Durumu</h5>
                    </div>
                    <div class="card-body">
                        <pre class="bg-light p-3 rounded">@System.Text.Json.JsonSerializer.Serialize(Model.ScanStatus, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })</pre>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Network Information -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-network-wired"></i> Yerel Ağ Aralıkları</h5>
                </div>
                <div class="card-body">
                    @if (Model.LocalNetworkRanges.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var range in Model.LocalNetworkRanges)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <code>@range</code>
                                    <button class="btn btn-outline-primary btn-sm" onclick="startQuickScan('@range')">
                                        <i class="fas fa-search"></i> Tara
                                    </button>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted">Yerel ağ aralığı bulunamadı</p>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Tarama Bilgileri</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success"></i> <strong>Genel Tarama:</strong> Tüm cihazları keşfeder</li>
                        <li><i class="fas fa-check text-success"></i> <strong>Port Tarama:</strong> Belirli port dinleyen cihazları bulur</li>
                        <li><i class="fas fa-check text-success"></i> <strong>CIDR Desteği:</strong> Ağ aralığını belirtebilirsiniz</li>
                        <li><i class="fas fa-check text-success"></i> <strong>Otomatik Kayıt:</strong> Bulunan cihazlar otomatik kaydedilir</li>
                    </ul>
                    
                    <div class="mt-3">
                        <h6>Örnekler:</h6>
                        <ul class="list-unstyled small text-muted">
                            <li><code>192.168.1.0/24</code> - 192.168.1.1-254 aralığı</li>
                            <li><code>10.0.0.0/16</code> - 10.0.0.1-65534 aralığı</li>
                            <li><code>172.16.0.0/12</code> - Özel ağ aralığı</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-refresh notice -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-sync-alt"></i> 
                Bu sayfa 30 saniyede bir otomatik olarak yenilenir. 
                Tarama sonuçlarını görmek için <a asp-page="/Devices/Index">Cihazlar</a> sayfasını kontrol edin.
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function updateNetworkRange(value) {
            const customInput = document.getElementById('customRangeInput');
            const networkRangeInput = document.querySelector('input[name="ScanRequest.NetworkRange"]');
            
            if (value === 'custom') {
                customInput.style.display = 'block';
                networkRangeInput.value = '';
            } else {
                customInput.style.display = 'none';
                networkRangeInput.value = value;
            }
        }

        function updatePortScanRange(value) {
            const customInput = document.getElementById('portCustomRangeInput');
            const portScanRangeInput = document.getElementById('portScanNetworkRange');
            
            if (value === 'custom') {
                customInput.style.display = 'block';
                portScanRangeInput.value = '';
            } else {
                customInput.style.display = 'none';
                portScanRangeInput.value = value;
            }
        }

        function setCommonPort(port) {
            if (port) {
                document.querySelector('input[name="ScanRequest.TargetPort"]').value = port;
            }
        }

        function startQuickScan(range) {
            document.querySelector('select[asp-for="ScanRequest.NetworkRange"]').value = range;
            document.querySelector('input[name="ScanRequest.NetworkRange"]').value = range;
            
            // Submit the form
            document.querySelector('form').submit();
        }

        // Handle custom range input for general scan
        document.getElementById('customRange')?.addEventListener('input', function() {
            document.querySelector('input[name="ScanRequest.NetworkRange"]').value = this.value;
        });

        // Handle custom range input for port scan
        document.getElementById('portCustomRange')?.addEventListener('input', function() {
            document.getElementById('portScanNetworkRange').value = this.value;
        });

        // Auto-refresh every 30 seconds
        setInterval(function() {
            if (document.visibilityState === 'visible') {
                location.reload();
            }
        }, 30000);
    </script>
}

@section Head {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .card {
            border: 1px solid #dee2e6;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .list-group-item {
            border: none;
            border-bottom: 1px solid #dee2e6;
        }
        
        pre {
            max-height: 200px;
            overflow-y: auto;
        }
        
        code {
            font-size: 0.875em;
        }
    </style>
}